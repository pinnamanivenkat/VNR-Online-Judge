From 234b54f4fbd239b31222b7170f272fc291d28f8a Mon Sep 17 00:00:00 2001
From: INT3NSE07 <d.jonathanpaul@gmail.com>
Date: Tue, 5 Mar 2019 21:51:04 +0530
Subject: [PATCH] Add create users support

---
 public/js/createUser.js | 51 +++++++++++++++++++++++++++++++++++++++++
 routes.js               |  6 ++++-
 views/adminPortal.ejs   |  5 +++-
 views/createUser.ejs    | 44 +++++++++++++++++++++++++++++++++++
 4 files changed, 104 insertions(+), 2 deletions(-)
 create mode 100644 public/js/createUser.js
 create mode 100644 views/createUser.ejs

diff --git a/public/js/createUser.js b/public/js/createUser.js
new file mode 100644
index 0000000..49fd9e3
--- /dev/null
+++ b/public/js/createUser.js
@@ -0,0 +1,51 @@
+$(() => {
+    var snackBar = $('#snackbar');
+    var nameRegex = /^[a-zA-Z ]{2,30}$/
+    var rollNumRegex = /^[a-zA-Z0-9]{10}$/
+
+    $('#createUserForm').submit(function (e) {
+        e.preventDefault();
+        var username = $('#username').val();
+        var name = $('#name').val();
+        var addUserType = $('input[name=addUserType]:checked').val();
+        var rollNumCheck = username.match(rollNumRegex)
+        var nameCheck = name.match(nameRegex)
+
+        if(addUserType == "user")
+            addUserType = null
+
+        if (rollNumCheck && nameCheck) {
+            $.ajax({
+                type: "POST",
+                url: "/createUser",
+                data: {
+                    username,
+                    name,
+                    addUserType
+                },
+                success: function (data) {
+                    if (!data.created) {
+                        handleError();
+                    }
+                    showFeedbackSnackBar(data.password);
+                },
+                error: handleError = function(xhr, status, error) {
+                    showFeedbackSnackBar("Roll number already exists");
+                }
+            });
+        } else if (!rollNumCheck) {
+            showFeedbackSnackBar("Roll number is invalid")
+        } else {
+            showFeedbackSnackBar("Display name is invalid")
+        }
+        return false;
+    });
+
+    function showFeedbackSnackBar(x) {
+        snackBar.text(x);
+        snackBar.addClass("snackbar_show");
+        setTimeout(function () {
+            snackBar.removeClass("snackbar_show");
+        }, 30000);
+    }
+});
diff --git a/routes.js b/routes.js
index 5eaf245..3358f85 100644
--- a/routes.js
+++ b/routes.js
@@ -68,6 +68,10 @@ router.post('/login', passport.authenticate('local'), function (req, res) {
     res.send(data);
 });
 
+router.get('/createUser', (req, res) => {
+    res.render('createUser');
+});
+
 router.post('/createUser', function (req, res) {
     let userConfig = {
         _id: req.body.username,
@@ -346,4 +350,4 @@ function isLoggedIn(req, res, next) {
     });
 }
 
-module.exports = router;
\ No newline at end of file
+module.exports = router;
diff --git a/views/adminPortal.ejs b/views/adminPortal.ejs
index b3b8a1a..d3ddb16 100644
--- a/views/adminPortal.ejs
+++ b/views/adminPortal.ejs
@@ -12,6 +12,9 @@
 <body>
 
     <button id="addProblem">My Problems</button>
+    <a href="/createUser">
+        <button>Create User</button>
+    </a>
 
     <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
         crossorigin="anonymous"></script>
@@ -22,4 +25,4 @@
     <script src="js/adminPortal.js"></script>
 </body>
 
-</html>
\ No newline at end of file
+</html>
diff --git a/views/createUser.ejs b/views/createUser.ejs
new file mode 100644
index 0000000..0ce2d92
--- /dev/null
+++ b/views/createUser.ejs
@@ -0,0 +1,44 @@
+<html lang="en">
+
+<head>
+    <meta charset="UTF-8">
+    <meta name="viewport" content="width=device-width, initial-scale=1.0">
+    <meta http-equiv="X-UA-Compatible" content="ie=edge">
+    <title>Create User | VNR Online Judge</title>
+    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
+        crossorigin="anonymous">
+    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
+        crossorigin="anonymous">
+    <link rel="stylesheet" href="css/login.css">
+</head>
+
+<body onload="disableNavigation()">
+    <div class="wrapper fadeInDown">
+        <div id="formContent">
+            <div class="fadeIn first">
+                <img src="user.svg" id="icon" alt="User Icon" />
+            </div>
+            <form id="createUserForm" onsubmit="return false">
+                <input type="text" id="username" autocomplete="off" class="fadeIn second" name="username" placeholder="Roll No">
+                <input type="text" id="name" autocomplete="off" class="fadeIn third" name="name" placeholder="Name"><br><br>
+                <input type="radio" name="addUserType" value="admin"> Admin
+                <input type="radio" name="addUserType" value="user" checked> User<br><br>
+                <input type="submit" class="fadeIn fourth" value="Create User">
+            </form>
+        </div>
+    </div>
+
+    <div id="snackbar">
+    </div>
+
+    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
+        crossorigin="anonymous"></script>
+    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
+        crossorigin="anonymous"></script>
+    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
+        crossorigin="anonymous"></script>
+    <script src="js/createUser.js"></script>
+    <script src="js/disableNavigation.js"></script>
+</body>
+
+</html>
-- 
2.20.1

